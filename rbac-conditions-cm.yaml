apiVersion: v1
kind: ConfigMap
metadata:
  name: rbac-conditions-cm
  namespace: rhdh-operator
data:
  rbac-conditional-policies.yaml: |
    result: CONDITIONAL
    roleEntityRef: role:default/developers
    pluginId: catalog
    resourceType: catalog-entity
    permissionMapping:
      - read
      - update
    conditions:
      anyOf:
        # Owner via user or any of the user's groups
        - rule: IS_ENTITY_OWNER
          resourceType: catalog-entity
          params:
            claims: ["$ownerRefs"]

        # Groups the caller belongs to
        - allOf:
            - rule: IS_ENTITY_KIND
              resourceType: catalog-entity
              params:
                kinds: ["Group"]
            - anyOf:
                - rule: HAS_SPEC
                  resourceType: catalog-entity
                  params:
                    key: members
                    value: "$currentUser"
                - rule: HAS_SPEC
                  resourceType: catalog-entity
                  params:
                    key: hasMember
                    value: "$currentUser"

        # All User entities
        - rule: IS_ENTITY_KIND
          resourceType: catalog-entity
          params:
            kinds: ["User"]
